<div class="budget-text-block">
  <!-- Vista de edición permanente -->
  <div class="block-edit">
    <div class="block-header-edit">
      <div class="form-group">
        <label for="encabezado-{{ block().id }}" class="form-label">
          Encabezado
        </label>
        <input
          type="text"
          id="encabezado-{{ block().id }}"
          [value]="block().heading"
          (input)="updateBlockField('heading', $event)"
          class="form-input"
          placeholder="Título del bloque">
      </div>
      <button
        (click)="deleteBlock()"
        class="btn-delete"
        type="button"
        title="Eliminar bloque">
        <span class="material-icons">delete</span>
      </button>
    </div>

    <!-- Secciones de descripción -->
    <div class="descriptions-section">
        <div class="descriptions-header">
          <label class="form-label">Secciones de Descripción</label>
          <button
            (click)="addDescriptionSection()"
            class="btn-add-section"
            type="button">
            Añadir Sección
          </button>
        </div>

        <div class="template-selector">
          <label class="template-label">Plantillas rápidas</label>
          <div class="template-controls">
            <select
              class="template-select"
              (change)="onTemplateChange($event)"
              [value]="selectedTemplateId() ?? ''">
              <option value="">Seleccionar plantilla</option>
              @for (template of templateOptions(); track template.id) {
                <option [value]="template.id">{{ template.name }}</option>
              }
            </select>
            <button
              type="button"
              class="btn-apply-template"
              [disabled]="!selectedTemplateId() || isApplyingTemplate()"
              (click)="applySelectedTemplate()">
              @if (isApplyingTemplate()) {
                <span>Aplicando…</span>
              } @else {
                <span>Aplicar plantilla</span>
              }
            </button>
            @if (selectedTemplateId()) {
              <button
                type="button"
                class="btn-delete-template"
                (click)="deleteSelectedTemplate()"
                [disabled]="isSavingTemplate()"
                title="Eliminar plantilla seleccionada">
                <span class="material-icons">delete</span>
              </button>
            }
          </div>

          <div class="template-save-section">
            @if (!isCreatingTemplate()) {
              <button
                type="button"
                class="btn-save-as-template"
                (click)="toggleCreateTemplate()">
                <span class="material-icons">save</span>
                Guardar como plantilla
              </button>
            } @else {
              <div class="create-template-form">
                <input
                  type="text"
                  [value]="newTemplateName()"
                  (input)="updateNewTemplateName($event)"
                  placeholder="Nombre de la plantilla"
                  class="template-name-input">
                <button
                  type="button"
                  class="btn-confirm-template"
                  (click)="saveAsTemplate()"
                  [disabled]="!newTemplateName() || isSavingTemplate()">
                  {{ isSavingTemplate() ? 'Guardando...' : 'Guardar' }}
                </button>
                <button
                  type="button"
                  class="btn-cancel-template"
                  (click)="toggleCreateTemplate()">
                  Cancelar
                </button>
              </div>
            }
          </div>
        </div>

        @for (descripcion of sections(); track descripcion.id; let idx = $index) {
          <div class="description-edit-item">
            <div class="description-edit-header">
              <span class="text-sm font-light text-gray-700 uppercase" style="letter-spacing: 0.05em;">Sección {{ idx + 1 }}</span>
              <button
                (click)="deleteDescriptionSection(descripcion.id)"
                class="btn-delete-section"
                type="button"
                title="Eliminar sección">
                <span class="material-icons">delete</span>
              </button>
            </div>

            <div class="form-group-inline">
              <label class="form-label-small">Título:</label>
              <input
                type="text"
                [value]="descripcion.title"
                (input)="updateDescriptionSection(descripcion.id, 'title', $event)"
                class="form-input-small"
                placeholder="Ej: NUESTRAS COCINAS">
            </div>

            <div class="form-group-inline">
              <label class="form-label-small">Texto:</label>
              <textarea
                [value]="descripcion.text"
                (input)="updateDescriptionSection(descripcion.id, 'text', $event)"
                [rows]="calculateRows(descripcion.text)"
                class="form-input-small"
                placeholder="Las cocinas Dica se diseñan..."></textarea>
            </div>
          </div>
        }

        @if (sections().length === 0) {
          <div class="empty-descriptions">
            <p class="text-gray-500 text-sm text-center">
              No hay secciones de descripción. Haz clic en "+ Añadir Sección" para comenzar.
            </p>
          </div>
        }
      </div>

      <div class="form-group">
        <label for="link-{{ block().id }}" class="form-label">
          Link (opcional)
        </label>
        <input
          type="url"
          id="link-{{ block().id }}"
          [value]="block().link || ''"
          (input)="updateBlockField('link', $event)"
          class="form-input"
          placeholder="https://ejemplo.com">
      </div>

      <div class="form-group">
        <label for="foto-{{ block().id }}" class="form-label">
          Imagen (URL o archivo)
        </label>
        <input
          type="url"
          id="foto-{{ block().id }}"
          [value]="block().imageUrl || ''"
          (input)="updateBlockField('imageUrl', $event)"
          class="form-input"
          placeholder="https://ejemplo.com/imagen.jpg">
        <div class="image-upload-actions">
          <input
            #blockImageInput
            type="file"
            class="sr-only"
            accept="image/*"
            (change)="onBlockImageSelected($event)">
          <button
            type="button"
            class="image-upload-btn"
            (click)="blockImageInput.click()"
            [disabled]="isUploadingImage()">
            <span class="material-symbols-rounded" aria-hidden="true">file_upload</span>
            {{ isUploadingImage() ? 'Subiendo...' : 'Subir archivo' }}
          </button>
          <span class="image-upload-hint">Puedes pegar una URL o subir una imagen JPG/PNG.</span>
        </div>
        @if (imageUploadError()) {
          <p class="form-error">{{ imageUploadError() }}</p>
        }
      </div>

      <div class="form-group">
        <label for="total-{{ block().id }}" class="form-label">
          Total (€)
        </label>
        <input
          type="number"
          id="total-{{ block().id }}"
          [value]="block().subtotal"
          (input)="updateBlockField('subtotal', $event)"
          step="0.01"
          min="0"
          class="form-input"
          placeholder="0.00">
      </div>
  </div>
</div>
