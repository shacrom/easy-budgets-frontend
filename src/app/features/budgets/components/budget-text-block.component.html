<div class="budget-text-block">
  @if (!isEditing()) {
    <!-- Vista de solo lectura -->
    <div class="block-view">
      <div class="block-header">
        <h3 class="text-xl font-bold text-gray-800 bg-green-100 px-4 py-2 rounded">
          {{ block().encabezado }}
        </h3>
        @if (editMode()) {
          <div class="actions">
            <button
              (click)="startEdit()"
              class="btn-edit"
              type="button">
              Editar
            </button>
            <button
              (click)="deleteBlock()"
              class="btn-delete"
              type="button">
              Eliminar
            </button>
          </div>
        }
      </div>

      <div class="block-content">
        <!-- Secciones de descripción -->
        @for (descripcion of block().descripciones; track descripcion.id) {
          <div class="description-section">
            <h4 class="description-title">{{ descripcion.titulo }}</h4>
            <p class="description-text">{{ descripcion.texto }}</p>
          </div>
        }

        @if (block().link) {
          <a
            [href]="block().link"
            target="_blank"
            rel="noopener noreferrer"
            class="text-blue-600 hover:underline mt-2 inline-block">
            Ver más información
          </a>
        }

        @if (block().foto) {
          <div class="block-image mt-4">
            <img
              [src]="block().foto"
              [alt]="block().encabezado"
              class="max-w-full h-auto rounded-lg shadow-md">
          </div>
        }
      </div>

      <div class="block-footer">
        <span class="text-lg font-semibold text-gray-900">
          Total: {{ block().total | currency:'EUR':'symbol':'1.2-2':'es-ES' }}
        </span>
      </div>
    </div>
  } @else {
    <!-- Vista de edición -->
    <div class="block-edit">
      <div class="form-group">
        <label for="encabezado-{{ block().id }}" class="form-label">
          Encabezado (fondo verde)
        </label>
        <input
          type="text"
          id="encabezado-{{ block().id }}"
          [value]="block().encabezado"
          (input)="updateBlockField('encabezado', $event)"
          class="form-input"
          placeholder="Título del bloque">
      </div>

      <!-- Secciones de descripción -->
      <div class="descriptions-section">
        <div class="descriptions-header">
          <label class="form-label">Secciones de Descripción</label>
          <button
            (click)="addDescriptionSection()"
            class="btn-add-section"
            type="button">
            + Añadir Sección
          </button>
        </div>

        @for (descripcion of block().descripciones; track descripcion.id; let idx = $index) {
          <div class="description-edit-item">
            <div class="description-edit-header">
              <span class="text-sm font-semibold text-gray-700">Sección {{ idx + 1 }}</span>
              <button
                (click)="deleteDescriptionSection(descripcion.id)"
                class="btn-delete-section"
                type="button"
                title="Eliminar sección">
                ✕
              </button>
            </div>

            <div class="form-group-inline">
              <label class="form-label-small">Título:</label>
              <input
                type="text"
                [value]="descripcion.titulo"
                (input)="updateDescriptionSection(descripcion.id, 'titulo', $event)"
                class="form-input-small"
                placeholder="Ej: NUESTRAS COCINAS">
            </div>

            <div class="form-group-inline">
              <label class="form-label-small">Texto:</label>
              <textarea
                [value]="descripcion.texto"
                (input)="updateDescriptionSection(descripcion.id, 'texto', $event)"
                rows="3"
                class="form-input-small"
                placeholder="Las cocinas Dica se diseñan..."></textarea>
            </div>
          </div>
        }

        @if (block().descripciones.length === 0) {
          <div class="empty-descriptions">
            <p class="text-gray-500 text-sm text-center">
              No hay secciones de descripción. Haz clic en "+ Añadir Sección" para comenzar.
            </p>
          </div>
        }
      </div>

      <div class="form-group">
        <label for="link-{{ block().id }}" class="form-label">
          Link (opcional)
        </label>
        <input
          type="url"
          id="link-{{ block().id }}"
          [value]="block().link || ''"
          (input)="updateBlockField('link', $event)"
          class="form-input"
          placeholder="https://ejemplo.com">
      </div>

      <div class="form-group">
        <label for="foto-{{ block().id }}" class="form-label">
          URL de la foto (opcional)
        </label>
        <input
          type="url"
          id="foto-{{ block().id }}"
          [value]="block().foto || ''"
          (input)="updateBlockField('foto', $event)"
          class="form-input"
          placeholder="https://ejemplo.com/imagen.jpg">
      </div>

      <div class="form-group">
        <label for="total-{{ block().id }}" class="form-label">
          Total (€)
        </label>
        <input
          type="number"
          id="total-{{ block().id }}"
          [value]="block().total"
          (input)="updateBlockField('total', $event)"
          step="0.01"
          min="0"
          class="form-input"
          placeholder="0.00">
      </div>

      <div class="form-actions">
        <button
          (click)="saveChanges()"
          class="btn-save"
          type="button">
          Guardar
        </button>
        <button
          (click)="cancelEdit()"
          class="btn-cancel"
          type="button">
          Cancelar
        </button>
      </div>
    </div>
  }
</div>
