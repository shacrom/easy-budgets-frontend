<section class="management-page budgets-page">
  <div class="actions-bar">
    <div class="search-field">
      <label for="budget-customer-search">Cliente</label>
      <input
        id="budget-customer-search"
        type="text"
        placeholder="Busca por nombre de cliente"
        [value]="customerFilter()"
        (input)="updateCustomerFilter($event)"
      />
    </div>

    <div class="inline-filters">
      <label class="compact-field">
        <span>Fecha desde</span>
        <input
          type="date"
          [value]="startDateFilter()"
          (change)="updateStartDate($event)"
        />
      </label>
      <label class="compact-field">
        <span>Fecha hasta</span>
        <input
          type="date"
          [value]="endDateFilter()"
          (change)="updateEndDate($event)"
        />
      </label>
      <label class="compact-field">
        <span>Ordenar por</span>
        <select [value]="sortField()" (change)="changeSortField($any($event.target).value)">
          @for (option of sortOptions; track option.value) {
            <option [value]="option.value">{{ option.label }}</option>
          }
        </select>
      </label>
    </div>

    <div class="actions-buttons">
      <button
        type="button"
        class="btn ghost"
        [disabled]="isLoading()"
        (click)="loadBudgets()">
        Actualizar
      </button>
      <button
        type="button"
        class="btn dark"
        [disabled]="isCreating()"
        (click)="createBudget()">
        @if (isCreating()) {
          <span>Creando...</span>
        } @else {
          <span>Nuevo Presupuesto</span>
        }
      </button>
    </div>
  </div>

  <div class="filters-footer">
    <button
      type="button"
      class="btn ghost"
      [disabled]="!hasFilters()"
      (click)="clearFilters()">
      Limpiar filtros
    </button>
  </div>

  @if (errorMessage()) {
    <div class="alert error">{{ errorMessage() }}</div>
  }

  <div class="management-layout">
    <div class="table-panel">
      @if (isLoading()) {
        <div class="mono text-center padded-state">Cargando presupuestos...</div>
      } @else if (budgets().length === 0) {
        <div class="mono text-center padded-state">
          No hay presupuestos creados. Haz clic en "Nuevo Presupuesto" para comenzar.
        </div>
      } @else if (totalFilteredBudgets() === 0) {
        <div class="mono text-center padded-state">
          No hay presupuestos que coincidan con los filtros aplicados.
          <button type="button" class="btn ghost" (click)="clearFilters()">Borrar filtros</button>
        </div>
      } @else {
        <table class="management-table">
          <thead>
            <tr>
              <th>Nº Presupuesto</th>
              <th>Título</th>
              <th>Cliente</th>
              <th>Estado</th>
              <th class="numeric">Total</th>
              <th>Creado</th>
              <th></th>
            </tr>
          </thead>
          <tbody>
            @for (budget of paginatedBudgets(); track budget.id) {
              <tr>
                <td class="mono">{{ budget.budgetNumber }}</td>
                <td>{{ budget.title }}</td>
                <td>{{ budget.customer?.name || 'Sin cliente' }}</td>
                <td>
                  <span [class]="'status-chip status-' + budget.status">
                    {{ formatStatus(budget.status) }}
                  </span>
                </td>
                <td class="mono numeric">{{ budget.total | currency:'EUR':'symbol':'1.2-2':'es' }}</td>
                <td>{{ budget.createdAt | date:'shortDate' }}</td>
                <td class="actions-cell">
                  <button type="button" class="btn icon" (click)="openBudget(budget.id)">
                    <span class="material-symbols-rounded" aria-hidden="true">edit</span>
                  </button>
                  <button
                    type="button"
                    class="btn icon"
                    [disabled]="duplicatingBudgetId() === budget.id"
                    (click)="duplicateBudget(budget)">
                    @if (duplicatingBudgetId() === budget.id) {
                      <span class="material-symbols-rounded loading-icon" aria-hidden="true">autorenew</span>
                    } @else {
                      <span class="material-symbols-rounded" aria-hidden="true">content_copy</span>
                    }
                  </button>
                  <button
                    type="button"
                    class="btn icon danger"
                    [disabled]="deletingBudgetId() === budget.id"
                    (click)="deleteBudget(budget)">
                    @if (deletingBudgetId() === budget.id) {
                      <span class="material-symbols-rounded loading-icon" aria-hidden="true">autorenew</span>
                    } @else {
                      <span class="material-symbols-rounded" aria-hidden="true">delete</span>
                    }
                  </button>
                </td>
              </tr>
            }
          </tbody>
        </table>

        <div class="pagination-bar" aria-label="Paginación de presupuestos">
          <div class="pagination-info">{{ paginationLabel() }}</div>
          <div class="pagination-controls">
            <label class="pagination-size" for="budgets-page-size">
              <span>Resultados por página</span>
              <select
                id="budgets-page-size"
                [value]="pageSize()"
                (change)="onPageSizeChange($event)">
                @for (option of pageSizeOptions; track option) {
                  <option [value]="option">{{ option }}</option>
                }
              </select>
            </label>

            <div class="pagination-page">{{ pagePosition() }}</div>

            <div class="pagination-buttons" role="group" aria-label="Botones de paginación">
              <button
                type="button"
                class="pagination-button"
                [disabled]="isOnFirstPage()"
                (click)="goToFirstPage()"
                aria-label="Primera página">
                <span class="material-symbols-rounded" aria-hidden="true">first_page</span>
              </button>
              <button
                type="button"
                class="pagination-button"
                [disabled]="isOnFirstPage()"
                (click)="goToPreviousPage()"
                aria-label="Página anterior">
                <span class="material-symbols-rounded" aria-hidden="true">chevron_left</span>
              </button>
              <button
                type="button"
                class="pagination-button"
                [disabled]="isOnLastPage()"
                (click)="goToNextPage()"
                aria-label="Página siguiente">
                <span class="material-symbols-rounded" aria-hidden="true">chevron_right</span>
              </button>
              <button
                type="button"
                class="pagination-button"
                [disabled]="isOnLastPage()"
                (click)="goToLastPage()"
                aria-label="Última página">
                <span class="material-symbols-rounded" aria-hidden="true">last_page</span>
              </button>
            </div>
          </div>
        </div>
      }
    </div>
  </div>
</section>
