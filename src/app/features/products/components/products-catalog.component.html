<section class="management-page products-page">
  <div class="actions-bar">
    <div class="search-field">
      <label for="product-search">Buscar</label>
      <input
        id="product-search"
        type="text"
        placeholder="Referencia, descripción, fabricante o categoría"
        [value]="searchTerm()"
        (input)="updateSearch($event)">
    </div>
    <div class="actions-buttons">
      <button
        type="button"
        class="btn ghost"
        [disabled]="isLoading()"
        (click)="loadProducts()">
        Actualizar
      </button>
      <button
        type="button"
        class="btn dark"
        (click)="openCreateForm()">
        Nuevo Producto
      </button>
    </div>
  </div>

  @if (errorMessage()) {
    <div class="alert error">{{ errorMessage() }}</div>
  }

  @if (successMessage()) {
    <div class="alert success">{{ successMessage() }}</div>
  }

  <div class="management-layout">
    <div class="table-panel">
      @if (isLoading() && products().length === 0) {
        <div class="mono text-center padded-state">Cargando productos...</div>
      } @else if (totalFilteredProducts() === 0) {
        <div class="mono text-center padded-state">No hay productos que coincidan con la búsqueda.</div>
      } @else {
        <table class="management-table">
          <thead>
            <tr>
              <th>Referencia</th>
              <th>Descripción</th>
              <th>Fabricante</th>
              <th>Categoría</th>
              <th class="numeric">Precio Base</th>
              <th class="numeric">IVA</th>
              <th class="numeric">Precio Final</th>
              <th>Estado</th>
              <th></th>
            </tr>
          </thead>
          <tbody>
            @for (product of paginatedProducts(); track product.id ?? product.reference) {
              <tr>
                <td>{{ product.reference }}</td>
                <td class="description-cell" [attr.title]="product.description">{{ product.description }}</td>
                <td>{{ product.manufacturer }}</td>
                <td>{{ product.category || '—' }}</td>
                <td class="numeric">{{ (product.basePrice || 0).toFixed(2) }}€</td>
                <td class="numeric">{{ product.vatRate || 0 }}%</td>
                <td class="numeric strong">
                  {{ ((product.basePrice || 0) * (1 + (product.vatRate || 0) / 100)).toFixed(2) }}€
                </td>
                <td>
                  <span class="badge" [class.badge-active]="product.active" [class.badge-inactive]="!product.active">
                    {{ product.active ? 'Activo' : 'Inactivo' }}
                  </span>
                </td>
                <td class="actions-cell">
                  <button type="button" class="btn icon" (click)="openEditForm(product)">
                    <span class="material-symbols-rounded" aria-hidden="true">edit</span>
                  </button>
                  <button type="button" class="btn icon danger" (click)="deleteProduct(product.id!)">
                    <span class="material-symbols-rounded" aria-hidden="true">delete</span>
                  </button>
                </td>
              </tr>
            }
          </tbody>
        </table>
      }
      <div class="pagination-bar" aria-label="Paginación del catálogo">
        <div class="pagination-info">{{ paginationLabel() }}</div>
        <div class="pagination-controls">
          <label class="pagination-size" for="products-page-size">
            <span>Resultados por página</span>
            <select
              id="products-page-size"
              [value]="pageSize()"
              (change)="onPageSizeChange($event)">
              @for (option of pageSizeOptions; track option) {
                <option [value]="option">{{ option }}</option>
              }
            </select>
          </label>

          <div class="pagination-page">{{ pagePosition() }}</div>

          <div class="pagination-buttons" role="group" aria-label="Botones de paginación">
            <button type="button" class="pagination-button" [disabled]="isOnFirstPage()" (click)="goToFirstPage()" aria-label="Primera página">
              <span class="material-symbols-rounded" aria-hidden="true">first_page</span>
            </button>
            <button type="button" class="pagination-button" [disabled]="isOnFirstPage()" (click)="goToPreviousPage()" aria-label="Página anterior">
              <span class="material-symbols-rounded" aria-hidden="true">chevron_left</span>
            </button>
            <button type="button" class="pagination-button" [disabled]="isOnLastPage()" (click)="goToNextPage()" aria-label="Página siguiente">
              <span class="material-symbols-rounded" aria-hidden="true">chevron_right</span>
            </button>
            <button type="button" class="pagination-button" [disabled]="isOnLastPage()" (click)="goToLastPage()" aria-label="Última página">
              <span class="material-symbols-rounded" aria-hidden="true">last_page</span>
            </button>
          </div>
        </div>
      </div>
    </div>
  </div>

  @if (showForm()) {
    <div class="modal-overlay" (click)="cancelForm()">
      <div class="form-panel" (click)="$event.stopPropagation()">
        <div class="form-header">
          <h3>{{ isEditing() ? 'Editar producto' : 'Nuevo producto' }}</h3>
        </div>

        <div class="form-grid">
          <label class="form-field">
            <span>Referencia *</span>
            <input type="text" [value]="formValues().reference" (input)="updateFormField('reference', $event)">
          </label>
          <label class="form-field">
            <span>Fabricante *</span>
            <input type="text" [value]="formValues().manufacturer" (input)="updateFormField('manufacturer', $event)">
          </label>
          <label class="form-field full">
            <span>Descripción *</span>
            <input type="text" [value]="formValues().description" (input)="updateFormField('description', $event)">
          </label>
          <label class="form-field">
            <span>Precio Base (€) *</span>
            <input type="number" step="0.01" min="0" [value]="formValues().basePrice" (input)="updateFormField('basePrice', $event)">
          </label>
          <label class="form-field">
            <span>IVA (%) *</span>
            <input type="number" step="1" min="0" max="100" [value]="formValues().vatRate" (input)="updateFormField('vatRate', $event)">
          </label>
          <label class="form-field">
            <span>Categoría</span>
            <input type="text" [value]="formValues().category || ''" (input)="updateFormField('category', $event)">
          </label>
          <label class="form-field checkbox full">
            <span>Estado</span>
            <div class="checkbox-control">
              <input
                id="product-active"
                type="checkbox"
                [checked]="formValues().active ?? true"
                (change)="updateFormField('active', $event)">
              <label for="product-active">Producto activo</label>
            </div>
          </label>
        </div>

        <div class="form-actions">
          <button type="button" class="btn dark" [disabled]="isLoading()" (click)="submitForm()">
            {{ isEditing() ? 'Guardar cambios' : 'Crear producto' }}
          </button>
          <button type="button" class="btn ghost" (click)="cancelForm()">Cancelar</button>
        </div>
      </div>
    </div>
  }
</section>
