<section class="summary-module">
  <header class="summary-header">
    <div>
      <h2>Resumen del presupuesto</h2>
    </div>
    <button type="button" class="btn ghost" (click)="toggleEditMode()">
      @if (editMode()) {
        <span class="material-symbols-rounded" aria-hidden="true">visibility</span>
        <span>Vista previa</span>
      } @else {
        <span class="material-symbols-rounded" aria-hidden="true">tune</span>
        <span>Configurar</span>
      }
    </button>
  </header>

  <div class="summary-card">
    <div class="accordion">
      <!-- Blocks accordion -->
      @if (effectiveTotalBlocks() > 0) {
        <div class="accordion-item">
          <button type="button" class="accordion-trigger" (click)="toggleBlocksExpanded()">
            <div class="trigger-label">
              <span class="material-symbols-rounded" aria-hidden="true">layers</span>
              <div>
                <span class="trigger-title">Mobiliario</span>
                <small>{{ blocks().length === 1 ? '1 bloque' : blocks().length + ' bloques' }}</small>
              </div>
            </div>
            <div class="trigger-value">
              <span>{{ effectiveTotalBlocks() | currency:'EUR':'symbol':'1.2-2':'es' }}</span>
              <span class="material-symbols-rounded" aria-hidden="true">
                {{ blocksExpanded() ? 'expand_less' : 'expand_more' }}
              </span>
            </div>
          </button>
          @if (blocksExpanded() && blocks().length > 0) {
            <div class="accordion-panel">
              @for (block of blocks(); track block.id) {
                <div class="detail-row">
                  <div>
                    <p class="detail-title">{{ block.heading || 'Bloque sin título' }}</p>
                    <p class="detail-subtitle">
                      {{ (block.descriptions?.length ?? 0) > 0 ? (block.descriptions?.length ?? 0) + ' secciones' : 'Sin secciones adicionales' }}
                    </p>
                  </div>
                  <span class="detail-value">
                    {{ block.subtotal | currency:'EUR':'symbol':'1.2-2':'es' }}
                  </span>
                </div>
              }
            </div>
          }
        </div>
      }

      <!-- Materials accordion -->
      @if (effectiveTotalMaterials() > 0) {
        <div class="accordion-item">
          <button type="button" class="accordion-trigger" (click)="toggleMaterialsExpanded()">
            <div class="trigger-label">
              <span class="material-symbols-rounded" aria-hidden="true">table_chart</span>
              <div>
                <span class="trigger-title">Tablas de materiales</span>
                <small>
                  @if (hasMaterialTables()) {
                    {{ materialTables().length === 1 ? '1 tabla' : materialTables().length + ' tablas' }}
                  } @else {
                    {{ materials().length === 1 ? '1 partida' : materials().length + ' partidas' }}
                  }
                </small>
              </div>
            </div>
            <div class="trigger-value">
              <span>{{ effectiveTotalMaterials() | currency:'EUR':'symbol':'1.2-2':'es' }}</span>
              <span class="material-symbols-rounded" aria-hidden="true">
                {{ materialsExpanded() ? 'expand_less' : 'expand_more' }}
              </span>
            </div>
          </button>
          @if (materialsExpanded() && (hasMaterialTables() || materials().length > 0)) {
            <div class="accordion-panel">
              @if (hasMaterialTables()) {
                @for (table of materialTables(); track table.id) {
                  <div class="detail-row">
                    <div>
                      <p class="detail-title">{{ table.title || 'Tabla sin título' }}</p>
                      <p class="detail-subtitle">{{ tableRowsLabel(table) }}</p>
                    </div>
                    <span class="detail-value">
                      {{ tableSubtotal(table) | currency:'EUR':'symbol':'1.2-2':'es' }}
                    </span>
                  </div>
                }
              } @else {
                @for (material of materials(); track material.id) {
                  <div class="detail-row">
                    <div>
                      <p class="detail-title">{{ material.description || 'Material sin descripción' }}</p>
                      <p class="detail-subtitle">
                        {{ material.manufacturer || 'Fabricante no definido' }} | Ref: {{ material.reference || '—' }}
                      </p>
                    </div>
                    <span class="detail-value">
                      {{ material.totalPrice | currency:'EUR':'symbol':'1.2-2':'es' }}
                    </span>
                  </div>
                }
              }
            </div>
          }
        </div>
      }

      <!-- Countertop section -->
      @if (effectiveTotalCountertop() > 0) {
        <div class="accordion-item">
          <div class="accordion-trigger" style="cursor: default;">
            <div class="trigger-label">
              <span class="material-symbols-rounded" aria-hidden="true">countertops</span>
              <div>
                <span class="trigger-title">Encimera</span>
              </div>
            </div>
            <div class="trigger-value">
              <span>{{ effectiveTotalCountertop() | currency:'EUR':'symbol':'1.2-2':'es' }}</span>
            </div>
          </div>
        </div>
      }

      <div class="summary-row subtotal">
        <span>Base imponible</span>
        <strong>{{ baseSubtotal() | currency:'EUR':'symbol':'1.2-2':'es' }}</strong>
      </div>
    </div>

    <!-- Additional lines -->
    @if (additionalLines().length > 0 || editMode()) {
      <div class="extras">
        <div class="extras-header">
          <div>
            <span class="material-symbols-rounded" aria-hidden="true">playlist_add</span>
            <p>Conceptos adicionales</p>
          </div>
          @if (editMode()) {
            <button type="button" class="btn ghost" (click)="addAdditionalLine()">
              <span class="material-symbols-rounded" aria-hidden="true">control_point</span>
              <span>Añadir</span>
            </button>
          }
        </div>

        @for (line of additionalLines(); track line.id) {
          <div class="extra-row" [class.is-optional]="isOptional(line)" [class.is-note]="isNote(line)">
            @if (!editMode()) {
              <div class="extra-content">
                <span class="type-pill">{{ lineTypeLabel(line.conceptType) }}</span>
                <span class="concept-text" [class.with-strike]="isOptional(line)">
                  {{ line.concept || 'Concepto' }}
                  @if (isOptional(line)) {
                    <sup>*</sup>
                  }
                </span>
              </div>
              @if (!isNote(line)) {
                <strong
                  [class.negative]="line.conceptType === 'discount'"
                  [class.optional-price]="isOptional(line)">
                  {{ displayAmount(line) | currency:'EUR':'symbol':'1.2-2':'es' }}
                  @if (isOptional(line)) {
                    <sup>*</sup>
                  }
                </strong>
              }
            } @else {
              <select
                class="input-field type-select"
                [(ngModel)]="line.conceptType"
                (ngModelChange)="updateLineType(line, $event)">
                @for (option of conceptTypeOptions; track option.value) {
                  <option [ngValue]="option.value">{{ option.label }}</option>
                }
              </select>
              <input
                class="input-field"
                type="text"
                [(ngModel)]="line.concept"
                (ngModelChange)="updateAdditionalLine(line)"
                placeholder="Descripción" />
              <input
                class="input-field amount"
                type="number"
                step="0.01"
                [disabled]="isNote(line)"
                [(ngModel)]="line.amount"
                (ngModelChange)="updateAdditionalLine(line)"
                placeholder="0,00" />
              <button type="button" class="icon-button" (click)="deleteAdditionalLine(line.id)">
                <span class="material-symbols-rounded" aria-hidden="true">delete</span>
              </button>
            }
          </div>
        }

        @if (additionalLines().length > 0) {
          <div class="extra-row total">
            <span>Base imponible con adicionales</span>
            <strong>{{ taxableBaseWithAdditionals() | currency:'EUR':'symbol':'1.2-2':'es' }}</strong>
          </div>
        }
      </div>
    }

    <div class="taxes">
      <div class="tax-row">
        <div>
          <span class="material-symbols-rounded" aria-hidden="true">percent</span>
          <p>IVA</p>
        </div>
        <div class="tax-controls">
          @if (editMode()) {
            <input
              type="number"
              class="input-field"
              min="0"
              max="100"
              step="0.5"
              [ngModel]="vatPercentage()"
              (ngModelChange)="updateVatPercentage($event)"
              placeholder="21" />
            <span>%</span>
          } @else {
            <span>{{ vatPercentage() }} %</span>
          }
          <strong>{{ vat() | currency:'EUR':'symbol':'1.2-2':'es' }}</strong>
        </div>
      </div>
    </div>

    <div class="grand-total">
      <div>
        <span class="material-symbols-rounded" aria-hidden="true">receipt_long</span>
        <p>Total general</p>
      </div>
      <strong>{{ grandTotal() | currency:'EUR':'symbol':'1.2-2':'es' }}</strong>
    </div>

    @if (hasOptionalLines()) {
      <p class="optional-footnote">* Los precios de los productos opcionales no se contabilizan sobre el total general.</p>
    }
  </div>
</section>
