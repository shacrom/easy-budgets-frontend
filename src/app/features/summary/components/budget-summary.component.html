<div class="budget-summary-container">
  <div class="header">
    <h2 class="text-2xl font-light text-gray-900 uppercase" style="letter-spacing: 0.15em;">Resumen del Presupuesto</h2>
    <button
      (click)="toggleEditMode()"
      class="btn-toggle-edit"
      type="button">
      @if (editMode()) {
        <span>Vista Previa</span>
      } @else {
        <span>Configurar</span>
      }
    </button>
  </div>

  <div class="summary-card">
    <!-- Main totals -->
    <div class="summary-section">
      <!-- Total Text Blocks -->
      <div class="summary-row clickable" (click)="toggleBlocksExpanded()">
        <div class="flex items-center gap-2">
          <span class="toggle-icon">{{ blocksExpanded() ? '▼' : '►' }}</span>
          <span class="summary-label">Total Bloques de Texto:</span>
        </div>
        <span class="summary-value">
          {{ totalBlocks() | currency:'EUR':'symbol':'1.2-2':'es' }}
        </span>
      </div>

      <!-- Blocks detail -->
      @if (blocksExpanded() && blocks().length > 0) {
        <div class="detail-section">
          @for (block of blocks(); track block.id) {
            <div class="detail-row">
              <span class="detail-label">{{ block.heading || 'Bloque sin título' }}</span>
              <span class="detail-value">
                {{ block.total | currency:'EUR':'symbol':'1.2-2':'es' }}
              </span>
            </div>
          }
        </div>
      }

      <!-- Total Materials -->
      <div class="summary-row clickable" (click)="toggleMaterialsExpanded()">
        <div class="flex items-center gap-2">
          <span class="toggle-icon">{{ materialsExpanded() ? '▼' : '►' }}</span>
          <span class="summary-label">Total Materiales:</span>
        </div>
        <span class="summary-value">
          {{ totalMaterials() | currency:'EUR':'symbol':'1.2-2':'es' }}
        </span>
      </div>

      <!-- Materials detail -->
      @if (materialsExpanded() && materials().length > 0) {
        <div class="detail-section">
          @for (material of materials(); track material.id) {
            <div class="summary-line">
              <span class="detail-label">
                {{ material.description || 'Material sin descripción' }}
                @if (material.manufacturer) {
                  <span class="text-gray-500 text-xs">({{ material.manufacturer }})</span>
                }
              </span>
              <span class="detail-value">
                {{ material.totalPrice | currency:'EUR':'symbol':'1.2-2':'es' }}
              </span>
            </div>
          }
        </div>
      }

      <div class="summary-row subtotal-row">
        <span class="summary-label font-semibold">Subtotal:</span>
        <span class="summary-value font-semibold">
          {{ subtotal() | currency:'EUR':'symbol':'1.2-2':'es' }}
        </span>
      </div>
    </div>

    <!-- Additional lines (discounts, extras, etc.) -->
    @if (additionalLines().length > 0 || editMode()) {
      <div class="summary-section additional-lines">
        <div class="section-header">
          <h3 class="text-sm font-semibold text-gray-700">Conceptos Adicionales</h3>
          @if (editMode()) {
            <button
              (click)="addAdditionalLine()"
              class="btn-add-line"
              type="button">
              + Añadir
            </button>
          }
        </div>

        @for (line of additionalLines(); track line.id) {
          <div class="summary-row additional-line">
            @if (!editMode()) {
              <span class="summary-label">{{ line.concept }}:</span>
              <span class="summary-value" [class.text-red-600]="line.amount < 0">
                {{ line.amount | currency:'EUR':'symbol':'1.2-2':'es' }}
              </span>
            } @else {
              <div class="flex gap-2 items-center w-full">
                <input
                  type="text"
                  [(ngModel)]="line.concept"
                  (ngModelChange)="updateAdditionalLine(line)"
                  class="input-field flex-1"
                  placeholder="Concepto (ej: Descuento, Extra)">
                <input
                  type="number"
                  [(ngModel)]="line.amount"
                  (ngModelChange)="updateAdditionalLine(line)"
                  step="0.01"
                  class="input-field w-32 text-right"
                  placeholder="0.00">
                <button
                  (click)="deleteAdditionalLine(line.id)"
                  class="btn-delete"
                  type="button">
                  ✕
                </button>
              </div>
            }
          </div>
        }

        @if (additionalLines().length > 0) {
          <div class="summary-row subtotal-row">
            <span class="summary-label font-semibold">Subtotal con Adicionales:</span>
            <span class="summary-value font-semibold">
              {{ taxableBase() | currency:'EUR':'symbol':'1.2-2':'es' }}
            </span>
          </div>
        }
      </div>
    }

    <!-- VAT -->
    <div class="summary-section iva-section">
      <div class="summary-row">
        <div class="flex items-center gap-2">
          <span class="summary-label">IVA</span>
          @if (editMode()) {
            <input
              type="number"
              [(ngModel)]="vatPercentage"
              min="0"
              max="100"
              step="0.1"
              class="input-field w-16 text-center"
              placeholder="21">
            <span class="text-sm text-gray-600">%</span>
          } @else {
            <span class="text-sm text-gray-600">({{ vatPercentage() }}%):</span>
          }
        </div>
        <span class="summary-value">
          {{ vat() | currency:'EUR':'symbol':'1.2-2':'es' }}
        </span>
      </div>
    </div>

    <!-- Grand Total -->
    <div class="summary-section total-section">
      <div class="summary-row total-row">
        <span class="summary-label-total">TOTAL GENERAL:</span>
        <span class="summary-value-total">
          {{ grandTotal() | currency:'EUR':'symbol':'1.2-2':'es' }}
        </span>
      </div>
    </div>
  </div>
</div>
