<div class="composite-blocks-container">
  <div class="header">
    <input
      class="section-title-input"
      type="text"
      [value]="sectionTitle()"
      placeholder="Título de la sección"
      (input)="updateSectionTitle($event)">
    <div class="header-actions">
      @if (hasUnsavedChanges()) {
        <span class="unsaved-indicator">
          <span class="material-symbols-rounded" aria-hidden="true">edit_note</span>
          <span>Cambios sin guardar</span>
        </span>
      }
      <button
        type="button"
        [class]="hasUnsavedChanges() ? 'btn solid' : 'btn ghost'"
        (click)="saveChanges()"
        [disabled]="isSaving() || !hasUnsavedChanges()">
        <span class="material-symbols-rounded" aria-hidden="true">save</span>
        <span>{{ isSaving() ? 'Guardando...' : 'Guardar cambios' }}</span>
      </button>
      <button
        (click)="addNewBlock()"
        class="btn-add-block"
        type="button"
        [disabled]="isCreating()">
        @if (isCreating()) {
          <span>Creando...</span>
        } @else {
          <span>Añadir Bloque</span>
        }
      </button>
    </div>
  </div>

  <div class="blocks-list">
    @if (isLoading()) {
      <div class="loading-state">
        <p class="text-gray-500 text-center">Cargando bloques...</p>
      </div>
    } @else if (blocks().length === 0) {
      <div class="empty-state">
        <p class="text-gray-500 text-center">
          No hay bloques añadidos. Haz clic en "Añadir Bloque" para empezar.
        </p>
      </div>
    } @else {
      @for (block of blocks(); track block.id) {
        <app-composite-block
          [block]="block"
          (blockUpdated)="updateBlock($event)"
          (blockDeleted)="deleteBlock($event)">
        </app-composite-block>
      }
    }
  </div>

  @if (blocks().length > 0) {
    <div class="total-section">
      <div class="total-label">Total General:</div>
      <div class="total-amount">
        {{ grandTotal() | currency:'EUR':'symbol':'1.2-2':'es' }}
      </div>
    </div>
  }
</div>
