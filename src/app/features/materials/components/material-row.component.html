@if (!editMode()) {
  <!-- Read-only view -->
  <tr class="material-row">
    <td class="material-cell reference">{{ material().reference || '—' }}</td>
    <td class="material-cell description">{{ material().description }}</td>
    <td class="material-cell manufacturer">{{ material().manufacturer }}</td>
    <td class="material-cell quantity">{{ material().quantity }}</td>
    <td class="material-cell price">
      {{ material().unitPrice | currency:'EUR':'symbol':'1.2-2':'es' }}
    </td>
    <td class="material-cell price-total">
      {{ totalPrice() | currency:'EUR':'symbol':'1.2-2':'es' }}
    </td>
    <td class="material-cell actions"></td>
  </tr>
} @else {
  <!-- Edit view -->
  <tr class="material-row edit-mode">
    <td class="material-cell reference">
      <div class="reference-field">
        <input
          type="text"
          [(ngModel)]="material().reference"
          (ngModelChange)="onReferenceChange($event)"
          (focus)="openReferenceDropdown()"
          (blur)="closeReferenceDropdown()"
          autocomplete="off"
          class="input-field"
          placeholder="Buscar referencia">
        @if (referenceDropdownOpen()) {
          <div class="reference-dropdown" role="listbox">
            @if (products().length === 0) {
              <p class="reference-empty">
                Catálogo no disponible
              </p>
            } @else if (referenceMatches().length === 0) {
              <p class="reference-empty">
                Sin coincidencias
              </p>
            } @else {
              <p class="reference-helper">Coincidencias del catálogo</p>
              <div class="reference-list">
                @for (product of referenceMatches(); track product.id ?? product.reference) {
                  <button
                    type="button"
                    class="reference-suggestion"
                    (mousedown)="applyProductFromSuggestion($event, product)"
                    role="option">
                    <span class="suggestion-reference">{{ product.reference }}</span>
                    <span class="suggestion-description">{{ product.description }}</span>
                  </button>
                }
              </div>
            }
          </div>
        }
      </div>
    </td>
    <td class="material-cell description">
      <input
        type="text"
        [(ngModel)]="material().description"
        (ngModelChange)="onValueChange()"
        class="input-field"
        style="text-overflow: ellipsis; overflow: hidden; white-space: nowrap;">
    </td>
    <td class="material-cell manufacturer">
      <input
        type="text"
        [(ngModel)]="material().manufacturer"
        (ngModelChange)="onValueChange()"
        class="input-field">
    </td>
    <td class="material-cell quantity">
      <input
        type="number"
        [(ngModel)]="material().quantity"
        (ngModelChange)="onValueChange()"
        min="0"
        step="0.01"
        class="input-field text-right"
        placeholder="0">
    </td>
    <td class="material-cell price">
      <input
        type="number"
        [(ngModel)]="material().unitPrice"
        (ngModelChange)="onValueChange()"
        min="0"
        step="0.01"
        class="input-field text-right"
        placeholder="0.00">
    </td>
    <td class="material-cell price-total">
      <span class="font-normal">
        {{ totalPrice() | currency:'EUR':'symbol':'1.2-2':'es' }}
      </span>
    </td>
    <td class="material-cell actions">
      <button
        (click)="deleteMaterial()"
        class="btn-delete-row no-bg"
        type="button"
        title="Eliminar material">
        <span class="material-symbols-rounded" aria-hidden="true">delete</span>
      </button>
    </td>
  </tr>
}
