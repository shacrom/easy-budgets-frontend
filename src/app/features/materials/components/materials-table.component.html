<section class="materials-module">
  <header class="module-header">
    <div class="module-title">
      <input
        class="section-title-input"
        type="text"
        [value]="sectionTitle()"
        placeholder="Título de la sección"
        (input)="updateSectionTitle($event)">
      @if (hasUnsavedChanges()) {
        <span class="unsaved-indicator">
          <span class="material-symbols-rounded" aria-hidden="true">edit_note</span>
          <span>Cambios sin guardar</span>
        </span>
      }
    </div>
    <div class="header-actions">
      @if (hasUnsavedChanges()) {
        <button
          type="button"
          class="btn ghost"
          (click)="discardChanges()"
          [disabled]="isSaving()">
          <span class="material-symbols-rounded" aria-hidden="true">undo</span>
          <span>Descartar</span>
        </button>
      }
      <button
        type="button"
        [class]="hasUnsavedChanges() ? 'btn solid' : 'btn ghost'"
        (click)="saveChanges()"
        [disabled]="isSaving() || !hasUnsavedChanges()">
        <span class="material-symbols-rounded" aria-hidden="true">save</span>
        <span>{{ isSaving() ? 'Guardando...' : 'Guardar cambios' }}</span>
      </button>
      <button type="button" class="btn solid" (click)="addTable()">
        <span class="material-symbols-rounded" aria-hidden="true">post_add</span>
        <span>Nueva tabla</span>
      </button>
    </div>
  </header>

  <div class="tables-grid">
    @if (tables().length === 0) {
      <div class="tables-empty">
        <span class="material-symbols-rounded" aria-hidden="true">grid_on</span>
        <p>Añade tu primera tabla para empezar a desglosar materiales.</p>
        <p class="hint">Utiliza "Nueva tabla" para crear el bloque inicial.</p>
      </div>
    } @else {
      @for (table of tables(); track table.id; let index = $index) {
      <article class="materials-card">
        <div class="card-header">
          <div class="title-group">
            <input
              class="table-title-input"
              [value]="table.title"
              type="text"
              placeholder="Título de la tabla"
              (input)="updateTableTitle(table.id, $event)">
            <p class="card-subtitle">Bloque {{ index + 1 }}</p>
          </div>
          <div class="card-actions">
            <button type="button" class="btn icon" (click)="addNewMaterial(table.id)">
              <span class="material-symbols-rounded" aria-hidden="true">add</span>
              <span>Fila</span>
            </button>
            <button
              type="button"
              class="btn icon danger"
              (click)="deleteTable(table.id)">
              <span class="material-symbols-rounded" aria-hidden="true">delete</span>
              <span>Tabla</span>
            </button>
          </div>
        </div>

        <div class="table-wrapper">
          <table class="materials-table">
            <colgroup>
              <col style="width: 26%;">
              <col style="width: 22%;">
              <col style="width: 16%;">
              <col style="width: 10%;">
              <col style="width: 14%;">
              <col style="width: 14%;">
              <col style="width: 8%;">
            </colgroup>
            <thead>
              <tr>
                <th>Referencia</th>
                <th>Descripción</th>
                <th>Fabricante</th>
                <th>Cantidad</th>
                <th>Precio unit.</th>
                <th>Precio total</th>
                <th>Acciones</th>
              </tr>
            </thead>
            <tbody>
              @if (table.rows.length === 0) {
                <tr>
                  <td colspan="7" class="empty-state">
                    <span class="material-symbols-rounded" aria-hidden="true">table_rows_narrow</span>
                    <p>Este bloque aún no tiene conceptos.</p>
                    <button type="button" class="btn ghost" (click)="addNewMaterial(table.id)">
                      <span class="material-symbols-rounded" aria-hidden="true">add</span>
                      <span>Añadir fila</span>
                    </button>
                  </td>
                </tr>
              } @else {
                @for (material of table.rows; track material.id) {
                  <app-material-row
                    [material]="material"
                    [products]="products()"
                    (deleteRequested)="deleteMaterial(table.id, $event)"
                    (localValuesChanged)="onMaterialLocalChange()">
                  </app-material-row>
                }
              }
            </tbody>
            <tfoot>
              <tr>
                <td colspan="5" class="footer-label">Subtotal</td>
                <td colspan="2" class="footer-amount">
                  {{ tableTotal(table) | currency:'EUR':'symbol':'1.2-2':'es' }}
                </td>
              </tr>
            </tfoot>
          </table>
        </div>
      </article>
      }
    }
  </div>

  <footer class="module-footer">
    <div>
      <p class="module-kicker">Total acumulado</p>
      <h3>{{ totalMaterials() | currency:'EUR':'symbol':'1.2-2':'es' }}</h3>
    </div>
  </footer>
</section>
